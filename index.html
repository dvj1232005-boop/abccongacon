<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>An Quy Ch·∫ø ‚Äì ƒêƒÉng k√Ω ca l√†m</title>

<!-- =========================
     PWA CORE
========================= -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b3d2e">

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="AnQuyChe">
<link rel="apple-touch-icon" href="icon-192.png">

<style>

/* ============================================================================
   SECTION 1 ‚Äì RESET & BASE
============================================================================ */
*,
*::before,
*::after{
  box-sizing:border-box;
  -webkit-tap-highlight-color:transparent;
}

html,body{
  margin:0;
  padding:0;
}

body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto;
  background:linear-gradient(180deg,#020617,#0f172a);
  color:var(--text);
  min-height:100vh;
  transition:background .4s,color .4s;
}

/* ============================================================================
   SECTION 2 ‚Äì THEME VARIABLES
============================================================================ */
:root{
  --bg:#020617;
  --bg-soft:#020617;
  --card:#ffffff;
  --card-soft:#f8fafc;
  --text:#0f172a;
  --muted:#64748b;

  --primary:#16a34a;
  --primary-soft:#dcfce7;

  --warn:#f59e0b;
  --warn-soft:#fef3c7;

  --danger:#dc2626;
  --danger-soft:#fee2e2;

  --chip:#f1f5f9;
  --border:#e5e7eb;

  --radius-xl:26px;
  --radius-lg:20px;
  --radius-md:14px;
  --radius-sm:10px;

  --shadow-soft:0 10px 25px rgba(0,0,0,.06);
  --shadow-hard:0 30px 60px rgba(0,0,0,.25);

  --transition-fast:.15s ease;
  --transition:.25s ease;
  --transition-slow:.4s ease;
}

/* DARK THEME */
[data-theme="dark"]{
  --bg:#020617;
  --card:#0f172a;
  --card-soft:#020617;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --chip:#020617;
  --border:#1e293b;
}

/* ============================================================================
   SECTION 3 ‚Äì LAYOUT
============================================================================ */
.app{
  max-width:430px;
  margin:auto;
  padding:18px 14px 40px;
}

.hidden{display:none}

/* ============================================================================
   SECTION 4 ‚Äì HEADER
============================================================================ */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  color:white;
  margin-bottom:16px;
}

.header-title h1{
  margin:0;
  font-size:22px;
  font-weight:700;
}

.header-title p{
  margin:4px 0 0;
  font-size:13px;
  opacity:.8;
}

.theme-toggle{
  font-size:20px;
  cursor:pointer;
  user-select:none;
}

/* ============================================================================
   SECTION 5 ‚Äì CARD
============================================================================ */
.card{
  background:var(--card);
  border-radius:var(--radius-xl);
  padding:20px;
  box-shadow:var(--shadow-hard);
  margin-bottom:16px;
  animation:cardFade .35s ease;
  transition:background .4s;
}

@keyframes cardFade{
  from{opacity:0;transform:translateY(12px)}
  to{opacity:1;transform:none}
}

.card h2{
  margin:0;
  font-size:20px;
}

.sub{
  margin-top:6px;
  font-size:13px;
  color:var(--muted);
}

/* ============================================================================
   SECTION 6 ‚Äì INPUT & BUTTON
============================================================================ */
input{
  width:100%;
  height:52px;
  font-size:16px;
  padding:0 16px;
  margin-top:12px;
  border-radius:var(--radius-md);
  border:1px solid var(--border);
  background:transparent;
  color:var(--text);
  transition:var(--transition);
}

input:focus{
  outline:none;
  border-color:var(--primary);
}

button{
  width:100%;
  height:52px;
  margin-top:14px;
  border:none;
  border-radius:18px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  transition:var(--transition-fast);
}

button:active{
  transform:scale(.96);
}

.btn-primary{
  background:linear-gradient(135deg,var(--primary),#22c55e);
  color:white;
}

.btn-secondary{
  background:#e5e7eb;
  color:#111;
}

.btn-danger{
  background:var(--danger-soft);
  color:var(--danger);
}

/* ============================================================================
   SECTION 7 ‚Äì DAY & CHIP SELECT
============================================================================ */
.day{
  margin-top:18px;
  font-size:13px;
  font-weight:700;
  color:var(--muted);
  text-transform:uppercase;
}

.chips{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:8px;
}

.chip{
  padding:8px 14px;
  border-radius:999px;
  background:var(--chip);
  border:1px solid var(--border);
  font-size:14px;
  cursor:pointer;
  transition:var(--transition);
}

.chip:hover{
  transform:translateY(-1px);
}

.chip.active{
  background:var(--primary);
  border-color:var(--primary);
  color:white;
  transform:scale(1.06);
}

/* ============================================================================
   SECTION 8 ‚Äì COUNTDOWN
============================================================================ */
.countdown{
  margin-top:10px;
  font-size:14px;
  font-weight:600;
}

.progress{
  height:6px;
  border-radius:999px;
  background:#e5e7eb;
  overflow:hidden;
  margin-top:6px;
}

.progress span{
  display:block;
  height:100%;
  width:0%;
  background:var(--primary);
  transition:width 1s linear, background .3s;
}

/* ============================================================================
   SECTION 9 ‚Äì TOAST
============================================================================ */
.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%) translateY(20px);
  background:#0f172a;
  color:white;
  padding:12px 18px;
  border-radius:999px;
  font-size:14px;
  opacity:0;
  pointer-events:none;
  transition:var(--transition-slow);
}

.toast.show{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}

/* ============================================================================
   SECTION 10 ‚Äì MANAGER SUMMARY
============================================================================ */
.shiftBox{
  background:var(--card-soft);
  border-radius:var(--radius-md);
  padding:12px;
  margin-top:10px;
}

.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  background:#14532d;
  color:white;
  font-size:13px;
  margin:4px 4px 0 0;
}

/* ============================================================================
   SECTION 11 ‚Äì FOOTER
============================================================================ */
footer{
  text-align:center;
  font-size:12px;
  color:#94a3b8;
  margin-top:20px;
}

</style>
</head>

<body data-theme="dark">

<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="header-title">
      <h1>An Quy Ch·∫ø</h1>
      <p>H·ªá th·ªëng ƒëƒÉng k√Ω ca l√†m n·ªôi b·ªô</p>
    </div>
    <div class="theme-toggle" onclick="toggleTheme()">üåô</div>
  </div>

  <!-- EMPLOYEE -->
  <div class="card" id="employeeBox">
    <h2>ƒêƒÉng k√Ω ca l√†m</h2>
    <div class="sub" id="lockStatus"></div>

    <div class="countdown" id="countdown"></div>
    <div class="progress"><span id="progressBar"></span></div>

    <input id="name" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n">
    <div id="form"></div>

    <button class="btn-primary" onclick="submitShift()">X√°c nh·∫≠n ƒëƒÉng k√Ω</button>
    <button class="btn-secondary" onclick="showManager()">Qu·∫£n l√Ω</button>
  </div>

  <!-- MANAGER -->
  <div class="card hidden" id="managerBox">
    <h2>Qu·∫£n l√Ω ca l√†m</h2>
    <input id="pin" type="password" placeholder="Nh·∫≠p m√£ PIN">
    <button class="btn-primary" onclick="loginManager()">ƒêƒÉng nh·∫≠p</button>
    <div id="summary"></div>
    <button class="btn-secondary" onclick="logoutManager()">ƒêƒÉng xu·∫•t</button>
    <button class="btn-danger" onclick="clearAll()">X√≥a to√†n b·ªô</button>
  </div>

  <footer>¬© 2025 An Quy Ch·∫ø ‚Ä¢ ƒê√†o ƒêƒÉng T√πng</footer>
</div>

<div class="toast" id="toast"></div>

<script>
/* ============================================================================
   SCRIPT ‚Äì PART 1
   (CORE STATE, THEME, CONFIG)
============================================================================ */

/* THEME */
function toggleTheme(){
  const b=document.body;
  const next=b.dataset.theme==="dark"?"light":"dark";
  b.dataset.theme=next;
  localStorage.setItem("theme",next);
  document.querySelector(".theme-toggle").textContent=
    next==="dark"?"üåô":"‚òÄÔ∏è";
}

(function initTheme(){
  const t=localStorage.getItem("theme")||"dark";
  document.body.dataset.theme=t;
  document.querySelector(".theme-toggle").textContent=
    t==="dark"?"üåô":"‚òÄÔ∏è";
})();

/* CONFIG */
const DAYS=["T2","T3","T4","T5","T6","T7","CN"];
const SHIFTS=[
  "C1",
  "C2",
  "C3",
  "F1",
  "F2",
  "2C (C1+C2)",
  "2C (C2+C3)"
];
const ADMIN_PIN="2005";

/* =========================
   PH·∫¶N 1 K·∫æT TH√öC ·ªû ƒê√ÇY
   (KH√îNG ƒê√ìNG </script>, </body>, </html>)
   ‚Üí PH·∫¶N 2 S·∫º N·ªêI TI·∫æP
========================= */
/* ============================================================================
   SCRIPT ‚Äì PART 2
   (TIME ENGINE, DATA LAYER, STATE, MANAGER, PWA)
============================================================================ */

/* ============================================================================
   TIME ENGINE ‚Äì LOCK & COUNTDOWN
============================================================================ */

/*
  Quy ∆∞·ªõc:
  - ƒêƒÉng k√Ω m·ªü t·ª´ Th·ª© 2
  - Kh√≥a l√∫c 20:00 Th·ª© 7
  - Ch·ªß nh·∫≠t lu√¥n kh√≥a
*/

function getLockTime(){
  const now = new Date();
  const lock = new Date(now);

  const day = lock.getDay(); // 0 CN ‚Üí 6 T7
  const diff = (6 - day + 7) % 7;

  lock.setDate(lock.getDate() + diff);
  lock.setHours(20, 0, 0, 0);

  if (now > lock) {
    lock.setDate(lock.getDate() + 7);
  }

  return lock;
}

let LOCK_TIME = getLockTime();

function isLocked(){
  const now = new Date();
  return now >= LOCK_TIME || now.getDay() === 0;
}

/* ============================================================================
   COUNTDOWN RENDER
============================================================================ */

const countdownEl = document.getElementById("countdown");
const progressBar = document.getElementById("progressBar");
const lockStatusEl = document.getElementById("lockStatus");

function renderCountdown(){
  const now = new Date();

  if (isLocked()) {
    countdownEl.textContent = "‚õî ƒê√£ kh√≥a ƒëƒÉng k√Ω";
    lockStatusEl.textContent = "M·ªü l·∫°i v√†o Th·ª© 2";
    progressBar.style.width = "100%";
    progressBar.style.background = "var(--danger)";
    disableAllChips();
    return;
  }

  const diff = LOCK_TIME - now;
  const total = 7 * 24 * 60 * 60 * 1000;
  const percent = 100 - (diff / total * 100);

  const h = Math.floor(diff / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  const s = Math.floor((diff % 60000) / 1000);

  countdownEl.textContent =
    `‚è≥ C√≤n ${h}h ${m}m ${s}s s·∫Ω kh√≥a ƒëƒÉng k√Ω`;
  lockStatusEl.textContent = "ƒêang m·ªü ƒëƒÉng k√Ω";

  progressBar.style.width = percent + "%";

  if (h < 1) {
    progressBar.style.background = "var(--warn)";
  } else {
    progressBar.style.background = "var(--primary)";
  }
}

setInterval(renderCountdown, 1000);
renderCountdown();

/* ============================================================================
   FORM RENDER ‚Äì CHIP SELECT ENGINE
============================================================================ */

const form = document.getElementById("form");
const selectedShifts = {};

function renderForm(){
  DAYS.forEach(day => {
    const wrap = document.createElement("div");

    const dayLabel = document.createElement("div");
    dayLabel.className = "day";
    dayLabel.textContent = day;

    const chipWrap = document.createElement("div");
    chipWrap.className = "chips";

    SHIFTS.forEach(shift => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = shift;

      chip.addEventListener("click", () => {
        if (isLocked()) {
          toast("‚õî ƒê√£ kh√≥a ƒëƒÉng k√Ω");
          return;
        }

        chipWrap.querySelectorAll(".chip")
          .forEach(c => c.classList.remove("active"));

        chip.classList.add("active");
        selectedShifts[day] = shift;
      });

      chipWrap.appendChild(chip);
    });

    wrap.appendChild(dayLabel);
    wrap.appendChild(chipWrap);
    form.appendChild(wrap);
  });
}

renderForm();

/* ============================================================================
   DISABLE CHIP WHEN LOCKED
============================================================================ */

function disableAllChips(){
  document.querySelectorAll(".chip").forEach(c => {
    c.style.pointerEvents = "none";
    c.style.opacity = ".5";
  });
}

/* ============================================================================
   TOAST ENGINE
============================================================================ */

function toast(message){
  const t = document.getElementById("toast");
  t.textContent = message;
  t.classList.add("show");

  setTimeout(() => {
    t.classList.remove("show");
  }, 2200);
}

/* ============================================================================
   DATA LAYER ‚Äì LOCAL STORAGE
============================================================================ */

function loadData(){
  return JSON.parse(localStorage.getItem("shiftData") || "[]");
}

function saveData(data){
  localStorage.setItem("shiftData", JSON.stringify(data));
}

/* ============================================================================
   VALIDATION
============================================================================ */

function validateSubmit(name){
  if (!name) {
    toast("Vui l√≤ng nh·∫≠p t√™n");
    return false;
  }
  if (Object.keys(selectedShifts).length === 0) {
    toast("Ch∆∞a ch·ªçn ca l√†m");
    return false;
  }
  return true;
}

/* ============================================================================
   SUBMIT HANDLER
============================================================================ */

function submitShift(){
  if (isLocked()) {
    toast("‚õî ƒê√£ kh√≥a ƒëƒÉng k√Ω");
    return;
  }

  const name = document.getElementById("name").value.trim();

  if (!validateSubmit(name)) return;

  const data = loadData();

  data.push({
    name: name,
    shifts: { ...selectedShifts },
    createdAt: Date.now()
  });

  saveData(data);

  toast("‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng");
}

/* ============================================================================
   MANAGER ‚Äì AUTH
============================================================================ */

function showManager(){
  document.getElementById("managerBox").classList.remove("hidden");
}

function loginManager(){
  const pin = document.getElementById("pin").value;

  if (pin !== ADMIN_PIN) {
    toast("Sai m√£ PIN");
    return;
  }

  document.getElementById("employeeBox").classList.add("hidden");
  renderSummary();
}

function logoutManager(){
  document.getElementById("employeeBox").classList.remove("hidden");
  document.getElementById("managerBox").classList.add("hidden");
}

/* ============================================================================
   MANAGER ‚Äì SUMMARY RENDER
============================================================================ */

function renderSummary(){
  const data = loadData();
  const summary = {};

  data.forEach(entry => {
    Object.entries(entry.shifts).forEach(([day, shift]) => {
      if (!summary[day]) summary[day] = {};
      if (!summary[day][shift]) summary[day][shift] = [];
      summary[day][shift].push(entry.name);
    });
  });

  const box = document.getElementById("summary");
  box.innerHTML = "";

  DAYS.forEach(day => {
    if (!summary[day]) return;

    const dayTitle = document.createElement("div");
    dayTitle.className = "day";
    dayTitle.textContent = day;
    box.appendChild(dayTitle);

    SHIFTS.forEach(shift => {
      if (!summary[day][shift]) return;

      const sb = document.createElement("div");
      sb.className = "shiftBox";

      const title = document.createElement("b");
      title.textContent =
        `${shift} (${summary[day][shift].length})`;

      sb.appendChild(title);
      sb.appendChild(document.createElement("br"));

      summary[day][shift].forEach(name => {
        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = name;
        sb.appendChild(badge);
      });

      box.appendChild(sb);
    });
  });
}

/* ============================================================================
   CLEAR ALL DATA
============================================================================ */

function clearAll(){
  if (confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu ƒëƒÉng k√Ω?")) {
    localStorage.removeItem("shiftData");
    location.reload();
  }
}

/* ============================================================================
   SERVICE WORKER REGISTER
============================================================================ */

if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("service-worker.js")
      .then(() => {
        console.log("‚úÖ Service Worker registered");
      })
      .catch(err => {
        console.error("‚ùå SW registration failed", err);
      });
  });
}

/* ============================================================================
   END OF SCRIPT
============================================================================ */
</script>

</body>
</html>


